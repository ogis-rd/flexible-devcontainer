## テスト

[devcontainers/cli feature test](https://github.com/devcontainers/cli/blob/main/docs/features/test.md)

### フォルダ構成

features配下にsrc、testフォルダを配置する構成はdevcontainer-cliでfeatur testの仕様

### ローカルでのテスト実行方法

※`DevContainer`内でテストは出来ません、WSL環境でテストを実行してください。

- devcontainer-cliのインストール  
事前にnodeのインストールが必要
  ```
  npm install -g @devcontainers/cli
  ```

- テストで利用するベースイメージのビルド  
  証明書が必要なローカル環境ではビルド前に以下のコードを追加する  
  ```
  RUN apt-get update \
    && apt-get install -y ca-certificates

  COPY *.crt /usr/local/share/ca-certificates/
  RUN update-ca-certificates
  ENV NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/cacert.crt
  ```
  ビルドの実行(/.devcontainer/Dockerfile)
  ```
  docker build --build-arg USERNAME=test -t ghcr.io/ogis-rd/flexible-devcontainer/flexible-devcontainer:test .
  ```
  テスト時に利用するベースイメージはscenarios.jsonで指定している

- テストの実行  
  全テストケースの実行
  ```
  devcontainer features test -p src/features --skip-autogenerated --skip-duplicated
  ```
  featureを指定して実行
  ```
  devcontainer features test -p src/features -f flexible-devcontainer-aws-cli --skip-autogenerated --skip-duplicated
  ```

## メモ
### featureのバージョン一括置換
Jsonファイル内に`//コメント`のようにJsonでサポートしていないコメントの記載があるとエラーになります。
```
new_version="1.2.0"
target_dir="src"

# JSONファイルを再帰的に検索し、versionを置換
find "$target_dir" -name 'devcontainer-feature.json' | while read -r file; do
  echo $file
  jq --arg new_version "$new_version" '.version = $new_version' "$file" > "$file.tmp" && mv "$file.tmp" "$file"
done
```